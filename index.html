<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS CDI Listening Practice</title>
    <style>
        /* Login Page Styles */
        #loginPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
        }
        
        .login-container {
            width: 500px;
            padding: 30px;
            border: 2px solid #cc0000;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .login-title {
            text-align: center;
            color: #cc0000;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .login-field {
            margin-bottom: 15px;
        }
        
        .login-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .login-field input, .login-field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .test-type {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .test-type-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .start-test-btn {
            background: linear-gradient(to bottom, #ff3333, #cc0000);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        /* Rest of the original styles remain unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            line-height: 1.4;
            font-size: 16px;
            padding-bottom: 90px; /* nav-row height (80px) + some extra spacing */
        }

        .header {
            background-color: #ffffff;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 60px;
        }

        .ielts-logo {
            display: none;
        }

        .test-info {
            display: flex;
            align-items: center;
            gap: 30px;
            font-size: 14px;
            color: #333;
        }

        .audio-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .audio-icon {
            width: 16px;
            height: 16px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>') no-repeat center;
        }

        .header-icons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .telegram-link {
            color: #0088cc;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .telegram-link:hover {
            text-decoration: underline;
        }

        .telegram-link::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: currentColor;
            -webkit-mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            mask-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.56-6.4c.75-.29 1.4.22 1.2.94l-2.67 12.61c-.22.95-1.13 1.18-1.78.73l-4.5-3.32l-2.23 2.15c-.47.44-1.29.21-1.48-.37z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }

        #volume-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 4px;
            background: #ddd;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
        }

        #volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: none;
        }

        .icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon:hover {
            opacity: 1;
        }
        
        #play-pause-btn {
            background: none;
            border: none;
            padding: 0;
        }

        .main-container {
            margin-top: 60px;
            display: flex;
            background: #ffffff;
            padding-bottom: 100px; /* Space for bottom nav */
        }

        /* Left Panel */
        .left-panel {
            width: 100%;
            padding: 20px;
        }

        /* Right Panel */
        .right-panel {
            display: none;
            width: 50%;
            padding: 20px;
            position: relative;
        }

        .help-button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
        }

        .help-button:hover {
            background: #357abd;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .people-section {
            margin-bottom: 30px;
        }

        .people-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
        }

        .people-table th {
            text-align: left;
            padding: 10px;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .people-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }

        .person-name {
            font-size: 16px;
            font-weight: bold;
        }

        .question-number {
            background: white;
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
            color: #4a90e2;
            min-width: 30px;
            text-align: center;
        }

        .assigned-responsibility {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 14px;
            border: 1px solid #ddd;
        }

        .responsibilities-section {
            margin-bottom: 30px;
        }

        .responsibility-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .responsibility-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .responsibility-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .responsibility-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .questions-section {
            margin-bottom: 20px;
        }

        .question-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instruction {
            margin-bottom: 20px;
            font-size: 16px;
            color: #666;
        }

        /* Map Styles */
        .map-container {
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .map-svg {
            border: 2px solid #333;
            background: white;
        }

        .map-room {
            fill: #f9f9f9;
            stroke: #333;
            stroke-width: 1;
            cursor: pointer;
        }

        .map-text {
            font-family: Arial, sans-serif;
            font-size: 13px;
            text-anchor: middle;
            fill: #333;
        }

        .map-number {
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
            fill: #333;
        }

        .room-labels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .room-label {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .room-label:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .room-label.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        /* Navigation Arrows */
        .nav-arrows {
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            gap: 5px;
            z-index: 101;
        }

        .nav-arrow {
            width: 50px;
            height: 50px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
        }

        .nav-arrow:hover {
            background: #555;
        }

        .nav-arrow:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Bottom Navigation - Exact Match */
        .nav-row {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
        
            padding: 0;
            display: flex;
            align-items: center;
            height: 80px;
            z-index: 100;

            /* Allow horizontal scrolling on smaller screens */
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .footer__questionWrapper___1tZ46 {
            display: flex;
            align-items: center;
            margin-right: 20px;
            flex-shrink: 0;
        }


        .footer__questionNo___3WNct {
            background: none;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }

        .footer__questionNo___3WNct:hover {
            background-color: #f8f9fa;
        }

        .section-prefix {
            font-size: 16px;
        }

        .sectionNr {
            font-size: 16px;
            font-weight: bold;
            margin-right: 5px;
        }

        .attemptedCount {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
            font-weight: 400; /* Normal weight */
        }

        @media (max-width: 1024px) {
            .attemptedCount {
                display: none;
            }
        }

        .footer__questionWrapper___1tZ46.selected .attemptedCount {
            display: none;
        }

        .footer__subquestionWrapper___9GgoP {
            display: none;
            gap: 2px;
            margin-left: 10px;
        }

        .footer__questionWrapper___1tZ46.selected .footer__subquestionWrapper___9GgoP {
            display: flex;
            flex-wrap: wrap;
        }

        .subQuestion {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .subQuestion.answered {
            background-color: #e9ecef;
            border-color: #ddd;
        }
        .subQuestion.correct {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .subQuestion.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .subQuestion:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }

        .subQuestion.active {
            background-color: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        .subQuestion.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .footer__deliverButton___3FM07 {
            margin-left: auto;
            margin-right: 20px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s, border-color 0.2s;
            min-width: 170px;
            justify-content: center;
        }

        .footer__deliverButton___3FM07:hover {
            background-color: #e0e0e0;
            border-color: #bbb;
        }

        .footer__deliverButton___3FM07:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ddd;
        }

        .fa-check::before {
            content: "✓";
        }

        .hidden {
            display: none;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 140px;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background-color: #ffff00;
        }

        .comment-highlight {
            background-color: #90EE90;
            position: relative;
            cursor: help;
        }

        .comment-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .comment-highlight:hover .comment-tooltip {
            opacity: 1;
        }

        .question {
            margin-bottom: 40px;
        }
        .question p {
            margin-bottom: 10px;
        }
        .question ul, .question .people-table {
            margin-top: 0;
        }
        .question-prompt {
            margin-bottom: 20px;
        }
        .question ul {
            list-style: none;
            padding-left: 0;
        }
        .question ul li {
            margin-bottom: 5px;
        }
        .answer-input {
            border: 1px solid #888;
            border-radius: 4px;
            background-color: #fff;
            padding: 2px 5px;
            font-size: 16px;
            text-align: center;
            margin-right: 4px;
            margin-left: 4px;
        }
        .answer-input::placeholder {
            color: #999;
            font-weight: bold;
            text-align: center;
        }
        .answer-input.correct {
            border-color: #28a745;
            background-color: #e9f7ef;
        }
        .answer-input.incorrect {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }
        .answer-input {
            z-index: 10;
            position: relative;
            pointer-events: auto;
        }
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            align-items: flex-start;
        }
        .recommendations-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 200px;
        }
        .drag-item {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: move;
            font-size: 16px;
            transition: all 0.2s;
            user-select: none;
        }
        .drag-item:hover {
            background: #e9ecef;
        }
        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drop-zone {
            border: 1px dashed #ccc;
            border-radius: 4px;
            height: 40px;
            transition: background-color 0.2s, border-color 0.2s;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drop-zone.drag-over {
            background-color: #e6f4ff;
            border-color: #4a90e2;
        }
        .drop-zone.correct {
            background-color: #e9f7ef;
            border-color: #28a745;
            border-style: solid;
        }
        .drop-zone.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            border-style: solid;
        }
        .drop-zone .drag-item {
            cursor: default;
        }
        .drag-item.selected {
            border-color: #4a90e2;
            box-shadow: 0 0 0 1px #4a90e2;
        }
        .questions-container {
            width: 50%;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
        }
        .part-header {
            background-color: #f1f2ec;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .part-header p {
            margin: 0;
        }

        .question li.correct {
            color: #155724;
            font-weight: bold;
        }
        .question li.incorrect {
            color: #721c24;
        }
        .question li.correct::before {
            content: '✔ ';
            color: #28a745;
        }
        .question li.incorrect::before {
            content: '✖ ';
            color: #dc3545;
        }

        .example-box {
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .timer-container {
            display: none; /* Timer hidden */
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
        .timer-container .timer-tooltip {
            display: none;
        }

        .audio-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(40, 40, 40, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .audio-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 500px;
            padding: 20px;
            color: white;
        }
        .audio-modal-content p {
            font-size: 16px;
            line-height: 1.5;
            color: #eee;
        }
        .audio-modal-icon {
            margin-bottom: 20px;
        }
        .modal-play-btn {
            background-color: #000;
            color: white;
            border: 1px solid white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .modal-play-btn:hover {
            background-color: #333;
        }
        #goto-widget {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #goto-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #goto-btn {
            padding: 4px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }

        @keyframes flash {
            0% { background-color: #e6f4ff; }
            100% { background-color: transparent; }
        }

        .question.flash {
            animation: flash 1s ease-out;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        #score-summary {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #result-details table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        #result-details th, #result-details td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
        }
        #result-details th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        #result-details td:nth-child(1) {
            font-weight: bold;
            text-align: center;
        }
        .result-correct {
            color: #28a745;
            font-weight: bold;
        }
        .result-incorrect {
            color: #dc3545;
            font-weight: bold;
        }

        .context-menu-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .matching-container {
            display: flex;
            justify-content: space-between;
            gap: 40px;
            margin-top: 20px;
            align-items: flex-start;
        }
        .matching-table {
            flex: 4;
            border-collapse: collapse;
        }
        .matching-table th, .matching-table td {
            border: 1px solid #ddd;
            padding: 6px 12px;
            text-align: left;
            vertical-align: middle;
        }
        .matching-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .matching-table .drop-zone {
            height: 36px; /* narrower height to save space */
            min-width: 240px; /* provide larger area to drop options */
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        .matching-table .drop-zone .drag-item {
            width: 100%;
            text-align: center;
            padding: 4px 5px; /* reduce padding for narrower height */
        }
        .matching-options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            background-color: transparent;
            padding: 0;
            border: none;
            min-height: 250px;
            min-width: 280px; /* ensure enough width for long option text to stay on one line */
        }
        .matching-options-list .drag-item {
            white-space: nowrap; /* keep text on one line */
            width: 100%;
        }
        .matching-question-item .drop-zone .placeholder {
            color: #999;
            font-weight: bold;
        }

        .option strong,
        .question ul li label strong {
            display: none;
        }

        /* Mobile selection toolbar */
        .mobile-selection-menu {
            position: absolute;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            gap: 8px;
            z-index: 3000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
        .mobile-selection-menu button {
            background: transparent;
            border: 1px solid #fff;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .mobile-selection-menu.hidden {
            display: none;
        }

        /* === MCQ table styling for Questions 11-15 === */
        .mcq-table {
            width: 100%;
            border-collapse: collapse;
        }
        .mcq-table th,
        .mcq-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            vertical-align: middle;
        }
        .mcq-table th {
            background-color: #1e6de6; /* vibrant blue header like screenshot */
            color: #ffffff;
            font-weight: 600;
            text-align: center;
        }
        .mcq-table th:first-child {
            text-align: left;
        }
        .mcq-table tbody td:first-child {
            font-weight: 500;
            text-align: left;
        }
        .mcq-table tr:nth-child(even) td {
            background-color: #f8faff; /* subtle alternating row colour */
        }
        .mcq-table input[type="radio"] {
            transform: scale(1.1);
            cursor: pointer;
        }
        /* list of options (A, B, C) shown above the table */
        .mcq-options {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
        }
        .mcq-options li {
            margin-bottom: 4px;
            font-size: 16px;
        }

        /* Compact single-choice list */
        .single-choice-container { margin: 10px 0; display: flex; flex-direction: column; gap: 18px; }
        .single-choice label { display: block; margin-left: 20px; margin-top: 4px; font-size: 16px; }

        /* Responsive adjustments for tablets */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel {
                display: none;
            }
            .left-panel {
                width: 100%;
                padding: 20px 10px;
            }
            .questions-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <img src="https://github.com/kawsarahmedeeeee-png/Reading/blob/main/Bold.png?raw=true" alt="Juned Academy Logo" style="height: 60px; margin: 0 auto 20px; display: block;">
            <div class="login-title">IELTS Mock Test</div>
            
            <div class="login-field">
                <label for="fullName">Full Name:</label>
                <input type="text" id="fullName" placeholder="Enter your full name">
            </div>
            
            <div class="login-field">
                <label for="candidateNumber">Candidate Number:</label>
                <input type="text" id="candidateNumber" placeholder="Enter candidate number">
            </div>
            
            <div class="login-field">
                <label>Test Type:</label>
                <div class="test-type">
                    <div class="test-type-option">
                        <input type="radio" id="generalTraining" name="testType" value="General Training">
                        <label for="generalTraining">General Training</label>
                    </div>
                    <div class="test-type-option">
                        <input type="radio" id="academic" name="testType" value="Academic" checked>
                        <label for="academic">Academic</label>
                    </div>
                </div>
            </div>
            
            <div class="login-field">
                <label for="testDate">Test Date:</label>
                <input type="date" id="testDate">
            </div>
            
            <button class="start-test-btn" onclick="startTest()">Start Test</button>
        </div>
    </div>

    <!-- Main Test Interface (initially hidden) -->
    <div id="testInterface" style="display: none;">
        <div class="header">
            <img src="https://github.com/kawsarahmedeeeee-png/Reading/blob/main/Bold.png?raw=true" alt="Juned Academy Logo" style="height: 40px;">
            <div class="timer-container">
                <span class="timer-display">60:00</span>
            </div>
            <a href="https://t.me/+o3fAabQXQL1kMzll" target="_blank" class="telegram-link">
                <img src="https://github.com/kawsarahmedeeeee-png/Reading/blob/main/Bold.png?raw=true" alt="Juned Academy" style="height: 30px;">
            </a>
            <div class="header-icons">
                <button id="play-pause-btn" class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                </button>
                <div class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </div>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
        </div>

        <div class="main-container">
            <!-- Left Panel -->
            <div class="left-panel">
                
                <div id="part-1" class="question-part">
                    <div class="part-header">
                        <p><strong>Part 1</strong></p>
                        <p>Listen and answer questions 1–10.</p>
                    </div>
                    <div class="questions-container">  
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 1-10</strong><br>Complete the notes below.</p>
                                <p>Write <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> for each answer.</p>
                            </div>
                            
                            <p style="text-align: center;"><strong>Costwise Car Hire</strong></p>

                            <div class="example-box">
                                <p><strong>Example</strong></p>
                                <p>Number of offices in Sydney:&nbsp;&nbsp;&nbsp;&nbsp;<strong><em>3</em></strong></p>
                            </div>
                            
                            <p>Booking reference number: <input type="text" class="answer-input" id="q1" placeholder="1"></p>
                            <p>Office just by <input type="text" class="answer-input" id="q2" placeholder="2"> terminal.</p>
                            <p>Opening hours: <input type="text" class="answer-input" id="q3" placeholder="3">.</p>
                            <p>After-hours charge: $<input type="text" class="answer-input" id="q4" placeholder="4"></p>
                            <p>Cheapest model of car available: <input type="text" class="answer-input" id="q5" placeholder="5"></p>
                            <p>Information needed when hooking: <input type="text" class="answer-input" id="q6" placeholder="6"> number</p>
                            <p>Length of hire period: <input type="text" class="answer-input" id="q7" placeholder="7"></p>
                            <p>Reduce cost by driving under <input type="text" class="answer-input" id="q8" placeholder="8"> km per week.</p>
                            <p>Insurance does not cover: <input type="text" class="answer-input" id="q9" placeholder="9"></p>
                            <p>After hours put keys in box near the office on the <input type="text" class="answer-input" id="q10" placeholder="10"></p>
                        </div>
                    </div>
                </div>

                <div id="part-2" class="question-part hidden">
                    <div class="part-header">
                        <p><strong>Part 2</strong></p>
                        <p>Listen and answer questions 11–20.</p>
                    </div>
                    <div class="questions-container">
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 11-15</strong><br>The following are essential requirements for which jobs?</p>
                                <p><em>Write the correct letter, <strong>A, B</strong> or <strong>C</strong>, next to questions&nbsp;11-15.</em></p>
                            </div>
                            <ul class="mcq-options">
                                <li><strong>A.</strong> foreign languages</li>
                                <li><strong>B.</strong> willingness to travel abroad</li>
                                <li><strong>C.</strong> professional qualification</li>
                            </ul>
                            <div class="mcq-table-container">
                                <table class="mcq-table">
                                    <thead>
                                        <tr>
                                            <th style="width:45%">Categories of jobs</th>
                                            <th style="text-align:center">A</th>
                                            <th style="text-align:center">B</th>
                                            <th style="text-align:center">C</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>11</strong>&nbsp;&nbsp;&nbsp;&nbsp;conference organizer</td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q11" value="A" aria-label="11 A"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q11" value="B" aria-label="11 B"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q11" value="C" aria-label="11 C"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>12</strong>&nbsp;&nbsp;&nbsp;&nbsp;catering manager</td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q12" value="A" aria-label="12 A"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q12" value="B" aria-label="12 B"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q12" value="C" aria-label="12 C"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>13</strong>&nbsp;&nbsp;&nbsp;&nbsp;housekeeper</td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q13" value="A" aria-label="13 A"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q13" value="B" aria-label="13 B"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q13" value="C" aria-label="13 C"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>14</strong>&nbsp;&nbsp;&nbsp;&nbsp;fitness centre staff</td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q14" value="A" aria-label="14 A"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q14" value="B" aria-label="14 B"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q14" value="C" aria-label="14 C"></td>
                                        </tr>
                                        <tr>
                                            <td><strong>15</strong>&nbsp;&nbsp;&nbsp;&nbsp;reservations assistant</td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q15" value="A" aria-label="15 A"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q15" value="B" aria-label="15 B"></td>
                                            <td style="text-align: center; cursor: pointer;" data-enhanced="true"><input type="radio" name="q15" value="C" aria-label="15 C"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 16-20</strong><br>Choose <strong>FIVE</strong> answers from the box and drag the correct letter, <strong>A-G</strong>, to the spaces next to questions 16-20.</p>
                            </div>
                            <div class="matching-container">
                                <div style="flex: 2; text-align: center;">
                                    <p><strong>INTERNATIONAL FINEST GROUP</strong><br><strong>RECRUITMENT PROCEDURES</strong></p>
                                    <p>register interest in working for International Finest Group</p>
                                    <p>↓</p>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 8px 0;">receive personal code and check <div class="drop-zone" data-question="q16" style="min-width: 240px;"></div></div>
                                    <p>↓</p>
                                    <p>download application form</p>
                                    <p>↓</p>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 8px 0;">send in form and attach <div class="drop-zone" data-question="q17" style="min-width: 240px;"></div></div>
                                    <p>↓</p>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 8px 0;">receive reply and confirm <div class="drop-zone" data-question="q18" style="min-width: 240px;"></div></div>
                                    <p>↓</p>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 8px 0;">send in <div class="drop-zone" data-question="q19" style="min-width: 240px;"></div></div>
                                    <p>↓</p>
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 8px 0;">attend <div class="drop-zone" data-question="q20" style="min-width: 240px;"></div></div>
                                </div>
                                <div class="matching-options-list" style="flex: 1;">
                                    <div class="drag-item" draggable="true" data-value="A"> CV</div>
                                    <div class="drag-item" draggable="true" data-value="B"> names of referees</div>
                                    <div class="drag-item" draggable="true" data-value="C"> work permit</div>
                                    <div class="drag-item" draggable="true" data-value="D">recruitment seminar</div>
                                    <div class="drag-item" draggable="true" data-value="E">evidence of qualifications</div>
                                    <div class="drag-item" draggable="true" data-value="F">conditions of employment</div>
                                    <div class="drag-item" draggable="true" data-value="G"> initial interview</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="part-3" class="question-part hidden">
                    <div class="part-header">
                        <p><strong>Part 3</strong></p>
                        <p>Listen and answer questions 21–30.</p>
                    </div>
                    <div class="questions-container">

                        <!-- === Updated Section 3 content === -->

                        <!-- Questions 21-23 -->
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 21-23</strong></p>
                                <p>Choose <strong>THREE</strong> letters, <strong>A–G</strong>.</p>
                                <p>Which <strong>THREE</strong> factors should the student consider while selecting courses?</p>
                            </div>
                            <ul style="list-style: none; padding-left: 0; font-size: 16px;">
                                <li><label><input type="checkbox" name="q21-23" value="A"> class time</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="B"> course topic</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="C"> amount of homework</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="D"> ease of course</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="E"> relevant to future career</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="F"> course structure</label></li>
                                <li><label><input type="checkbox" name="q21-23" value="G"> professor reputation</label></li>
                            </ul>
                        </div>

                        <!-- Questions 24-27 -->
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 24-27</strong></p>
                                <p>Choose the correct letter, <strong>A</strong>, <strong>B</strong> or <strong>C</strong>.</p>
                            </div>
                            <div class="single-choice-container">
                                <div class="single-choice">
                                    <p><strong>24.</strong> The tutor recommends against taking Human Physiology because it would not be the best</p>
                                    <label><input type="radio" name="q24" value="A"> time management</label>
                                    <label><input type="radio" name="q24" value="B"> chance at earning an A</label>
                                    <label><input type="radio" name="q24" value="C">  topic for a research paper</label>
                                </div>

                                <div class="single-choice">
                                    <p><strong>25.</strong> The student decides to do a dissertation because</p>
                                    <label><input type="radio" name="q25" value="A"> he takes it to boost his GPA</label>
                                    <label><input type="radio" name="q25" value="B"> he likes to develop more supportive details</label>
                                    <label><input type="radio" name="q25" value="C"> he wants to conduct more interviews</label>
                                </div>

                                <div class="single-choice">
                                    <p><strong>26.</strong> The student thought the research paper was</p>
                                    <label><input type="radio" name="q26" value="A"> already completed</label>
                                    <label><input type="radio" name="q26" value="B"> worth finishing</label>
                                    <label><input type="radio" name="q26" value="C"> too complicated</label>
                                </div>

                                <div class="single-choice">
                                    <p><strong>27.</strong> The method of data collection was</p>
                                    <label><input type="radio" name="q27" value="A"> interviews</label>
                                    <label><input type="radio" name="q27" value="B"> lab studies</label>
                                    <label><input type="radio" name="q27" value="C"> questionnaires</label>
                                </div>
                            </div>
                        </div>

                        <!-- Questions 28-30 -->
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 28-30</strong></p>
                                <p>Write <strong>NO MORE THAN TWO WORDS</strong> for each answer.</p>
                            </div>
                            <p>First draft should be finished by the end of <input type="text" class="answer-input" id="q28" placeholder="28">.</p>
                            <p>Dissertation should be registered with the <input type="text" class="answer-input" id="q29" placeholder="29"> in the Department Office.</p>
                            <p>The student can get the relevant database from the <input type="text" class="answer-input" id="q30" placeholder="30"> Office.</p>
                        </div>
                        <!-- === End Updated Section 3 === -->
                    </div>
                </div>

                <div id="part-4" class="question-part hidden">
                    <div class="part-header">
                        <p><strong>Part 4</strong></p>
                        <p>Listen and answer questions 31–40.</p>
                    </div>
                    <div class="questions-container">
                        <div class="question">
                            <div class="question-prompt">
                                <p><strong>Questions 31-40</strong><br>Complete the notes below.</p>
                                <p>Write <strong>NO MORE THAN TWO WORDS</strong> for each answer.</p>
                            </div>
                            <p style="text-align: center;"><strong>History of Music in Britain</strong></p>
                            <p><strong>In the 18th century</strong></p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;During the Industrial Revolution people moved to cities to work in the <input type="text" class="answer-input" id="q31" placeholder="31">.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;In the 1850s, the culture was influenced greatly by <input type="text" class="answer-input" id="q32" placeholder="32"> from different countries.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;Originally music reflected the work life of different <input type="text" class="answer-input" id="q33" placeholder="33"> in those days.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;Different songs were created in the same <input type="text" class="answer-input" id="q34" placeholder="34">, although people were from a variety of nations.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;The songs written by the workers during this period mainly came from their feelings about harsh <input type="text" class="answer-input" id="q35" placeholder="35">.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;The musical trends were led by <input type="text" class="answer-input" id="q36" placeholder="36"> performers.</p>
                            <p><strong>In the 19th century</strong></p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;During this period, some musical groups had expanded their popularity among <input type="text" class="answer-input" id="q37" placeholder="37">.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;In the late 1870s, the <input type="text" class="answer-input" id="q38" placeholder="38"> came into contact with these flourishing musical traditions.</p>
                            <p><strong>Nowadays</strong></p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;These musical genres still exert an influence on <input type="text" class="answer-input" id="q39" placeholder="39"> culture.</p>
                            <p>&nbsp;&nbsp;•&nbsp;&nbsp;Enthusiastic fans are still collecting and keeping the <input type="text" class="answer-input" id="q40" placeholder="40"> of music from those days.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
            </div>
        </div>

        <audio id="global-audio-player" class="hidden"></audio>

        <!-- Navigation Arrows -->
        <div class="nav-arrows">
            <button class="nav-arrow" onclick="previousPart()" id="prevBtn" disabled="">‹</button>
            <button class="nav-arrow" onclick="nextPart()" id="nextBtn">›</button>
        </div>

        <!-- Bottom Navigation -->
        <nav class="nav-row perScorableItem" aria-label="Questions">
            <div class="footer__questionWrapper___1tZ46 multiple selected" role="tablist">
                <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(1)">
                    <span>
                        <span aria-hidden="true" class="section-prefix">Part </span>
                        <span class="sectionNr" aria-hidden="true">1</span>
                        <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                    </span>
                </button>
                <div class="footer__subquestionWrapper___9GgoP">
                    <button class="subQuestion scorable-item" onclick="goToQuestion(1)"><span class="sr-only">Question 1</span><span aria-hidden="true">1</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(2)"><span class="sr-only">Question 2</span><span aria-hidden="true">2</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(3)"><span class="sr-only">Question 3</span><span aria-hidden="true">3</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(4)"><span class="sr-only">Question 4</span><span aria-hidden="true">4</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(5)"><span class="sr-only">Question 5</span><span aria-hidden="true">5</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(6)"><span class="sr-only">Question 6</span><span aria-hidden="true">6</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(7)"><span class="sr-only">Question 7</span><span aria-hidden="true">7</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(8)"><span class="sr-only">Question 8</span><span aria-hidden="true">8</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(9)"><span class="sr-only">Question 9</span><span aria-hidden="true">9</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(10)"><span class="sr-only">Question 10</span><span aria-hidden="true">10</span></button>
                </div>
            </div>
            
            <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
                <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(2)">
                    <span>
                        <span aria-hidden="true" class="section-prefix">Part </span>
                        <span class="sectionNr" aria-hidden="true">2</span>
                        <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                    </span>
                </button>
                <div class="footer__subquestionWrapper___9GgoP">
                    <button class="subQuestion scorable-item" onclick="goToQuestion(11)"><span class="sr-only">Question 11</span><span aria-hidden="true">11</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(12)">
                        <span class="sr-only">Question 12</span>
                        <span aria-hidden="true">12</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(13)">
                        <span class="sr-only">Question 13</span>
                        <span aria-hidden="true">13</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(14)">
                        <span class="sr-only">Question 14</span>
                        <span aria-hidden="true">14</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(15)">
                        <span class="sr-only">Question 15</span>
                        <span aria-hidden="true">15</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(16)">
                        <span class="sr-only">Question 16</span>
                        <span aria-hidden="true">16</span>
                    </button>
                    <button class="subQuestion active scorable-item" onclick="goToQuestion(17)">
                        <span class="sr-only">Question 17</span>
                        <span aria-hidden="true">17</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(18)">
                        <span class="sr-only">Question 18</span>
                        <span aria-hidden="true">18</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(19)">
                        <span class="sr-only">Question 19</span>
                        <span aria-hidden="true">19</span>
                    </button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(20)">
                        <span class="sr-only">Question 20</span>
                        <span aria-hidden="true">20</span>
                    </button>
                </div>
            </div>
            
            <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
                <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(3)">
                    <span>
                        <span aria-hidden="true" class="section-prefix">Part </span>
                        <span class="sectionNr" aria-hidden="true">3</span>
                        <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                    </span>
                </button>
                <div class="footer__subquestionWrapper___9GgoP">
                    <button class="subQuestion scorable-item" onclick="goToQuestion(21)"><span class="sr-only">Question 21</span><span aria-hidden="true">21</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(22)"><span class="sr-only">Question 22</span><span aria-hidden="true">22</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(23)"><span class="sr-only">Question 23</span><span aria-hidden="true">23</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(24)"><span class="sr-only">Question 24</span><span aria-hidden="true">24</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(25)"><span class="sr-only">Question 25</span><span aria-hidden="true">25</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(26)"><span class="sr-only">Question 26</span><span aria-hidden="true">26</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(27)"><span class="sr-only">Question 27</span><span aria-hidden="true">27</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(28)"><span class="sr-only">Question 28</span><span aria-hidden="true">28</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(29)"><span class="sr-only">Question 29</span><span aria-hidden="true">29</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(30)"><span class="sr-only">Question 30</span><span aria-hidden="true">30</span></button>
                </div>
            </div>
            
            <div class="footer__questionWrapper___1tZ46 multiple" role="tablist">
                <button role="tab" class="footer__questionNo___3WNct" onclick="switchToPart(4)">
                    <span>
                        <span aria-hidden="true" class="section-prefix">Part </span>
                        <span class="sectionNr" aria-hidden="true">4</span>
                        <span class="attemptedCount" aria-hidden="true">0 of 10</span>
                    </span>
                </button>
                <div class="footer__subquestionWrapper___9GgoP">
                    <button class="subQuestion scorable-item" onclick="goToQuestion(31)"><span class="sr-only">Question 31</span><span aria-hidden="true">31</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(32)"><span class="sr-only">Question 32</span><span aria-hidden="true">32</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(33)"><span class="sr-only">Question 33</span><span aria-hidden="true">33</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(34)"><span class="sr-only">Question 34</span><span aria-hidden="true">34</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(35)"><span class="sr-only">Question 35</span><span aria-hidden="true">35</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(36)"><span class="sr-only">Question 36</span><span aria-hidden="true">36</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(37)"><span class="sr-only">Question 37</span><span aria-hidden="true">37</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(38)"><span class="sr-only">Question 38</span><span aria-hidden="true">38</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(39)"><span class="sr-only">Question 39</span><span aria-hidden="true">39</span></button>
                    <button class="subQuestion scorable-item" onclick="goToQuestion(40)"><span class="sr-only">Question 40</span><span aria-hidden="true">40</span></button>
                </div>
            </div>
            
            <button id="deliver-button" aria-label="Download your answers" class="footer__deliverButton___3FM07">
                <i class="fa fa fa-check" aria-hidden="true"></i>
                <span>Download Answers</span>
            </button>
        </nav>

        <!-- Context Menu -->
        <div id="contextMenu" class="context-menu" style="display: none;">
            <div class="context-menu-item" id="highlight-item" onclick="highlightText()">
                <span class="context-menu-icon">
                    <svg viewBox="0 0 24 24" fill="black"><path d="M15.24 12.32L12.28 9.36l-1.04 1.04-1.04-1.04-1.04 1.04-1.04-1.04-1.04 1.04-1.04-1.04-3.12 3.12c-.59.58-1.54.58-2.12 0l-1.04-1.04c-.58-.59-.58-1.54 0-2.12L7.88.88c.59-.58 1.54-.58 2.12 0l1.04 1.04 1.04-1.04 1.04 1.04 1.04-1.04 1.04 1.04 1.04-1.04 3.12 3.12c.58.59.58 1.54 0 2.12l-1.04 1.04c-.58.59-1.54.59-2.12 0zM12 15l-3 3-7-7 3-3 7 7zm-9-5l-2.29 2.29c-.39.39-.39 1.02 0 1.41l8.29 8.29c.39.39 1.02.39 1.41 0L22.7 8.41c.39-.39.39-1.02 0-1.41L14.42.29c-.39-.39-1.02-.39-1.41 0L3 10z"></path></svg>
                </span>
                <span>Highlight</span>
            </div>
            <div class="context-menu-item" id="comment-item" onclick="addComment()">
                <span class="context-menu-icon">
                    <svg viewBox="0 0 24 24" fill="black"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 12H5.17L4 15.17V4h16v10z"></path></svg>
                </span>
                <span>Comment</span>
            </div>
            <div class="context-menu-item" id="clear-item" onclick="clearHighlight()" style="display:none;">
                <span class="context-menu-icon">
                    <svg viewBox="0 0 24 24" fill="black"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                </span>
                <span>Clear</span>
            </div>
            <div class="context-menu-item" onclick="clearAllHighlights()">
                <span class="context-menu-icon">
                    <svg viewBox="0 0 24 24" fill="black"><path d="M16 9h-2.29l3-3-1.42-1.42-3 3V5h-2v2.29l-3-3-1.42 1.42 3 3H5v2h2.29l-3 3 1.42 1.42 3-3V17h2v-2.29l3 3 1.42-1.42-3-3H17V9h-2zm-4 4h-2v-2h2v2z"></path></svg>
                </span>
                <span>Clear All</span>
            </div>
        </div>

        <!-- Mobile highlight/comment toolbar -->
        <div id="mobile-selection-menu" class="mobile-selection-menu hidden">
            <button onclick="highlightText()">Highlight</button>
            <button onclick="addComment()">Comment</button>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Your Results</h2>
                    <button id="modal-close-button" class="modal-close-btn">×</button>
                </div>
                <div class="modal-body">
                    <p id="score-summary"></p>
                    <div id="result-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Login and Navigation Functions
        function startTest() {
            const fullName = document.getElementById('fullName').value;
            const candidateNumber = document.getElementById('candidateNumber').value;
            const testDate = document.getElementById('testDate').value;
            
            if (!fullName || !candidateNumber || !testDate) {
                alert('Please fill in all fields');
                return;
            }
            
            localStorage.setItem('studentFullName', fullName);
            localStorage.setItem('studentCandidateNumber', candidateNumber);
            localStorage.setItem('studentTestType', document.querySelector('input[name="testType"]:checked').value);
            localStorage.setItem('studentTestDate', testDate);
            
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('testInterface').style.display = 'block';
        }

        // Set today's date as default for the test date
        window.onload = function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();
            
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            
            const formattedToday = `${yyyy}-${mm}-${dd}`;
            document.getElementById('testDate').value = formattedToday;
        };

        // Rest of the original JavaScript code remains unchanged
        let currentPart = 1;
        let currentQuestion = 1;
        let selectedText = '';
        let selectedRange = null;
        let draggedElement = null;
        let testStarted = false;
        let timeInSeconds = 3600;
        let isHovering = false;
        let timerInterval;
        let contextElement = null;

        function updateAnsweredIndicators() {
            for (let qNum = 1; qNum <= 40; qNum++) {
                const btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${qNum})"]`);
                if (!btn) continue;

                // Do not change style if it's already marked correct or incorrect
                if (btn.classList.contains('correct') || btn.classList.contains('incorrect')) {
                    continue;
                }

                let isAnswered = false;
                const textInput = document.getElementById(`q${qNum}`);
                const radioInput = document.querySelector(`input[name="q${qNum}"]:checked`);
                const dropZone = document.querySelector(`.drop-zone[data-question="q${qNum}"]`);

                if (textInput && textInput.value.trim() !== '') {
                    isAnswered = true;
                } else if (radioInput) {
                    isAnswered = true;
                } else if (dropZone && dropZone.children.length > 0) {
                    isAnswered = true;
                } else if ((qNum >= 2 && qNum <= 3) && document.querySelector('input[name="q2-3"]:checked')) {
                    isAnswered = true;
                } else if ((qNum >= 21 && qNum <= 23) && document.querySelector('input[name="q21-23"]:checked')) {
                    isAnswered = true;
                }

                if (isAnswered) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.remove('answered');
                }
            }
        }

        const audioPlayer = document.getElementById('global-audio-player');
        const timerContainer = document.querySelector('.timer-container');
        const timerDisplay = document.querySelector('.timer-display');
        const volumeSlider = document.getElementById('volume-slider');
        const playPauseBtn = document.getElementById('play-pause-btn');

        const audioSources = {
            1: 'https://ieltstrainingonline.com/wp-content/uploads/2021/07/2019-IELTS-Listening-Actual-Test-15-Section1.mp3?_=1',
            2: 'https://ieltstrainingonline.com/wp-content/uploads/2021/07/2019-IELTS-Listening-Actual-Test-15-Section2.mp3?_=2',
            3: 'https://ieltstrainingonline.com/wp-content/uploads/2021/07/IELTS-Recent-Actual-Test-With-Answers-Practice-Test-12-Section3.mp3?_=3',
            4: 'https://ieltstrainingonline.com/wp-content/uploads/2021/07/2019-IELTS-Listening-Actual-Test-06-Section4.mp3?_=4'
        };

        const correctAnswers = {
            // === Section 1 (Questions 1-10) ===
            'q1': ['743002'],
            'q2': 'international',
            'q3': ['6.45', '06.45', '6:45', '06:45', '6.45 am', '06.45 am', '6:45 am', '06:45 am'],
            'q4': ['30', 'thirty'],
            'q5': 'echo',
            'q6': ['credit card'],
            'q7': ['7 days', 'seven days', 'one week', '1 week', 'a week'],
            'q8': ['1000', 'one thousand', '1 thousand', 'a thousand', 'thousand'],
            'q9': ['luggage', 'his luggage', 'the luggage'],
            'q10': 'pavement',

            // === Section 2 (Questions 11-20) ===
            'q11': 'A',
            'q12': 'C',
            'q13': 'B',
            'q14': 'C',
            'q15': 'A',
            'q16': 'F',
            'q17': 'A',
            'q18': 'G',
            'q19': 'E',
            'q20': 'D',

            // === Section 3 (Questions 21-30) ===
            'q21-23': ['B','E','F'],
            'q24': 'A',
            'q25': 'B',
            'q26': 'C',
            'q27': 'A',
            'q28': 'March',
            'q29': 'secretary',
            'q30': 'computer',

            // === Section 4 (Questions 31-40) ===
            'q31': 'factories',
            'q32': 'immigration',
            'q33': 'industries',
            'q34': 'language',
            'q35': 'jobs',
            'q36': 'young',
            'q37': 'audiences',
            'q38': 'middle class',
            'q39': 'classical',
            'q40': 'recordings'
        };

        function setupCheckboxLimits() {
            const checkboxGroups = [
                { name: 'q2-3', limit: 2 },
                { name: 'q21-23', limit: 3 }
            ];

            checkboxGroups.forEach(group => {
                const checkboxes = document.querySelectorAll(`input[name="${group.name}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('click', () => {
                        const checkedCount = document.querySelectorAll(`input[name="${group.name}"]:checked`).length;
                        if (checkedCount > group.limit) {
                            checkbox.checked = false;
                        }
                    });
                });
            });
        }

        function switchToPart(partNumber, andPlay = false) {
            if (currentPart !== partNumber) {
                const firstQuestionOfPart = (partNumber - 1) * 10 + 1;
                currentQuestion = firstQuestionOfPart;
            }
            
            currentPart = partNumber;
            audioPlayer.pause();
            playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
            audioPlayer.src = audioSources[partNumber];

            updateNavigation();
            document.querySelectorAll('.question-part').forEach(part => part.classList.add('hidden'));
            const partToShow = document.getElementById(`part-${partNumber}`);
            if (partToShow) {
                partToShow.classList.remove('hidden');
            }
            if (andPlay) {
                audioPlayer.play();
            }
            updateNavigation();
        }

        function updateNavigation() {
            document.querySelectorAll('.footer__questionWrapper___1tZ46').forEach((wrapper, index) => {
                wrapper.classList.remove('selected');
                updateAttemptedCount(index + 1);
            });
            const currentWrapper = document.querySelectorAll('.footer__questionWrapper___1tZ46')[currentPart - 1];
            if (currentWrapper) {
                currentWrapper.classList.add('selected');
            }
            document.getElementById('prevBtn').disabled = currentQuestion === 1;
            document.getElementById('nextBtn').disabled = currentQuestion === 40;
        }

        function goToQuestion(questionNumber) {
            currentQuestion = questionNumber;
            let partNumber = 1;
            if (questionNumber > 10 && questionNumber <= 20) partNumber = 2;
            else if (questionNumber > 20 && questionNumber <= 30) partNumber = 3;
            else if (questionNumber > 30) partNumber = 4;
            if (currentPart !== partNumber) {
                switchToPart(partNumber);
            }
            document.querySelectorAll('.subQuestion').forEach(btn => btn.classList.remove('active'));
            const questionBtn = document.querySelector(`.subQuestion[onclick="goToQuestion(${questionNumber})"]`);
            if (questionBtn) questionBtn.classList.add('active');

            // Scroll to the question
            let questionElement;
            if (questionNumber >= 2 && questionNumber <= 3) {
                questionElement = document.querySelector('input[name="q2-3"]');
            } else if (questionNumber >= 21 && questionNumber <= 23) {
                questionElement = document.querySelector('input[name="q21-23"]');
            } else {
                questionElement = document.getElementById(`q${questionNumber}`) || // text inputs
                                  document.querySelector(`[data-question="q${questionNumber}"]`) || // drag-drop
                                  document.querySelector(`input[name="q${questionNumber}"]`); // radio buttons
            }
            
            if (questionElement) {
                const questionContainer = questionElement.closest('.question');
                if(questionContainer) {
                    questionContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    questionContainer.classList.add('flash');
                    setTimeout(() => {
                        questionContainer.classList.remove('flash');
                    }, 1000);
                }
            }
            updateNavigation();
        }

        function nextPart() {
            if (currentQuestion < 40) {
                goToQuestion(currentQuestion + 1);
            }
        }

        function previousPart() {
            if (currentQuestion > 1) {
                goToQuestion(currentQuestion - 1);
            }
        }

        function highlightText() {
            if (!selectedRange || selectedRange.collapsed) {
                closeContextMenu();
                return;
            }
            try {
                const span = document.createElement('span');
                span.className = 'highlight';
                selectedRange.surroundContents(span);
            } catch(err){
                console.warn('Complex selection – fallback highlight');
                document.execCommand('backColor', false, 'yellow');
            }
            window.getSelection().removeAllRanges();
            closeContextMenu();
        }

        function addComment() {
            const commentText = prompt('Enter your comment:');
            if (!commentText || !selectedRange || selectedRange.collapsed) {
                closeContextMenu();
                return;
            }
            try {
                const span = document.createElement('span');
                span.className = 'comment-highlight';
                const tooltip = document.createElement('span');
                tooltip.className = 'comment-tooltip';
                tooltip.textContent = commentText;
                span.appendChild(tooltip);
                selectedRange.surroundContents(span);
            }catch(err){
                console.warn('Complex selection – cannot comment');
            }
            window.getSelection().removeAllRanges();
            closeContextMenu();
        }

        function clearHighlight() {
            const elementToClear = contextElement; // Set by contextmenu handler
            if (!elementToClear) {
                closeContextMenu();
                return;
            }

            const highlightId = elementToClear.getAttribute('data-highlight-id');
            const elementsToClear = highlightId
                ? Array.from(document.querySelectorAll(`[data-highlight-id="${highlightId}"]`))
                : [elementToClear];

            let commonParent = null;
            if (elementsToClear.length > 0) {
                commonParent = elementsToClear[0].parentNode;
            }

            elementsToClear.forEach(element => {
                const parent = element.parentNode;
                const fragment = document.createDocumentFragment();

                while (element.firstChild) {
                    // Don't keep the tooltip for comments. Just unwrap everything.
                    if (element.firstChild.nodeType === 1 && element.firstChild.classList.contains('comment-tooltip')) {
                        element.removeChild(element.firstChild);
                    } else {
                        fragment.appendChild(element.firstChild);
                    }
                }
                parent.replaceChild(fragment, element);
            });
            
            if (commonParent) {
                commonParent.normalize(); // Merges adjacent text nodes
            }
            
            closeContextMenu();
        }

        function clearAllHighlights() {
            document.querySelectorAll('.highlight, .comment-highlight').forEach(element => {
                const parent = element.parentNode;
                const fragment = document.createDocumentFragment();

                while (element.firstChild) {
                    if (element.firstChild.nodeType === 1 && element.firstChild.classList.contains('comment-tooltip')) {
                        element.removeChild(element.firstChild);
                    } else {
                        fragment.appendChild(element.firstChild);
                    }
                }
                parent.replaceChild(fragment, element);
            });
            closeContextMenu();
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextElement = null;
        }

        function updateAttemptedCount(partNumber) {
            const partContainer = document.getElementById(`part-${partNumber}`);
            if (!partContainer) return;
            const inputs = partContainer.querySelectorAll('input.answer-input:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled])');
            let answeredCount = 0;
            const answeredGroups = {};
            inputs.forEach(input => {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    if (input.checked && !answeredGroups[input.name]) {
                        answeredCount++;
                        answeredGroups[input.name] = true;
                    }
                } else {
                    if (input.value.trim() !== '') answeredCount++;
                }
            });
            const countDisplay = document.querySelector(`.footer__questionWrapper___1tZ46:nth-child(${partNumber}) .attemptedCount`);
            if (countDisplay) countDisplay.textContent = `${answeredCount} of 10`;
        }

        function downloadAnswers() {
            const name = localStorage.getItem('studentFullName');
            const candidateNumber = localStorage.getItem('studentCandidateNumber');
            const testType = localStorage.getItem('studentTestType');
            const testDate = localStorage.getItem('studentTestDate');
            
            let answersContent = `IELTS Listening Test Submission\n`;
            answersContent += `================================\n`;
            answersContent += `Name: ${name}\n`;
            answersContent += `Candidate Number: ${candidateNumber}\n`;
            answersContent += `Test Type: ${testType}\n`;
            answersContent += `Test Date: ${testDate}\n\n`;
            
            // Collect all answers
            for (let qNum = 1; qNum <= 40; qNum++) {
                let answer = '';
                const textInput = document.getElementById(`q${qNum}`);
                const radioInput = document.querySelector(`input[name="q${qNum}"]:checked`);
                const dropZone = document.querySelector(`.drop-zone[data-question="q${qNum}"]`);
                
                if (textInput && textInput.value.trim() !== '') {
                    answer = textInput.value;
                } else if (radioInput) {
                    answer = radioInput.value;
                } else if (dropZone && dropZone.children.length > 0) {
                    answer = dropZone.querySelector('.drag-item').getAttribute('data-value');
                } else if ((qNum >= 2 && qNum <= 3) && document.querySelector('input[name="q2-3"]:checked')) {
                    const checkedBoxes = Array.from(document.querySelectorAll('input[name="q2-3"]:checked'));
                    answer = checkedBoxes.map(cb => cb.value).join(', ');
                } else if ((qNum >= 21 && qNum <= 23) && document.querySelector('input[name="q21-23"]:checked')) {
                    const checkedBoxes = Array.from(document.querySelectorAll('input[name="q21-23"]:checked'));
                    answer = checkedBoxes.map(cb => cb.value).join(', ');
                } else {
                    answer = 'No answer provided';
                }
                
                answersContent += `Question ${qNum}: ${answer}\n`;
            }
            
            // Create and download file
            const blob = new Blob([answersContent], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${name}_IELTS_Listening_Answers.txt`;
            link.click();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeInSeconds--;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeInSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Time's up!";
                    downloadAnswers();
                }
            }, 1000);
        }

        // Event Listeners
        playPauseBtn.addEventListener('click', () => {
            if (!testStarted) {
                testStarted = true;
                startTimer();
                switchToPart(currentPart, true);
            } else {
                if (audioPlayer.paused) {
                    // If paused, ensure the audio source is for the current part
                    if (!audioPlayer.src.includes(audioSources[currentPart])) {
                        audioPlayer.src = audioSources[currentPart];
                    }
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            }
        });
        
        audioPlayer.addEventListener('play', () => {
            playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        });

        audioPlayer.addEventListener('pause', () => {
            playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
        });

        audioPlayer.addEventListener('ended', () => {
            if (currentPart < 4) {
                switchToPart(currentPart + 1, true);
            }
        });

        volumeSlider.addEventListener('input', (e) => audioPlayer.volume = e.target.value);
        document.getElementById('deliver-button').addEventListener('click', downloadAnswers);
        
        // Go To Question Widget Logic
        const gotoWidget = document.getElementById('goto-widget');
        const gotoInput = document.getElementById('goto-input');
        const gotoBtn = document.getElementById('goto-btn');

        document.addEventListener('keydown', (e) => {
            if (e.key >= '0' && e.key <= '9' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                gotoWidget.classList.remove('hidden');
                gotoInput.focus();
                gotoInput.value = e.key;
            }
            if (e.key === 'Enter' && document.activeElement === gotoInput) {
                gotoBtn.click();
            }
            if (e.key === 'Escape') {
                gotoWidget.classList.add('hidden');
                gotoInput.value = '';
            }
        });

        if (gotoBtn) {
            gotoBtn.addEventListener('click', () => {
                const qNum = parseInt(gotoInput.value, 10);
                if (qNum >= 1 && qNum <= 40) {
                    goToQuestion(qNum);
                    gotoWidget.classList.add('hidden');
                    gotoInput.value = '';
                } else {
                    alert('Please enter a number between 1 and 40.');
                }
            });
        }

        // Add listener for the modal close button
        document.getElementById('modal-close-button').addEventListener('click', () => {
            document.getElementById('result-modal').style.display = 'none';
        });

        // === Tap-to-select & tap-to-drop for drag items (mobile support) ===
        document.body.addEventListener('click', function(e){
            const item = e.target.closest('.drag-item');
            if(item && item.getAttribute('draggable')){
                // Toggle selection
                document.querySelectorAll('.drag-item.selected').forEach(i=>i.classList.remove('selected'));
                item.classList.add('selected');
                draggedElement = item;
                return;
            }
            const dz = e.target.closest('.drop-zone');
            if(dz && draggedElement){
                // If already filled, move old back
                const optionsList = document.querySelector('.matching-options-list');
                if(dz.children.length>0 && dz.firstElementChild!==draggedElement){
                    optionsList.appendChild(dz.firstElementChild);
                }
                dz.appendChild(draggedElement);
                draggedElement.classList.remove('selected');
                draggedElement=null;
                updateAnsweredIndicators();
            }
        });

        // === Mobile highlight/comment toolbar ===
        const mobileToolbar = document.getElementById('mobile-selection-menu');
        function positionToolbar(){
            const sel = window.getSelection();
            if(sel.rangeCount===0 || sel.isCollapsed){
                mobileToolbar.classList.add('hidden');
                return;
            }
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            mobileToolbar.style.top = window.scrollY + rect.top - mobileToolbar.offsetHeight - 8 + 'px';
            mobileToolbar.style.left = window.scrollX + rect.left + 'px';
            mobileToolbar.classList.remove('hidden');
        }
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            if(sel && sel.rangeCount>0 && !sel.isCollapsed){
                selectedRange = sel.getRangeAt(0);
                selectedText = sel.toString();
            }
            if('ontouchstart' in window || navigator.maxTouchPoints>0){
                setTimeout(positionToolbar, 0);
            }
        });
        document.addEventListener('click', (e)=>{
            if(!e.target.closest('#mobile-selection-menu')){
                mobileToolbar.classList.add('hidden');
            }
        });

        /* ---------------- Drag and Drop for Matching Questions ---------------- */

        (function initDragAndDrop() {
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            const optionLists = document.querySelectorAll('.matching-options-list');

            let draggedElement = null;

            dragItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            [...dropZones, ...optionLists].forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                if (zone.classList.contains('drop-zone')) {
                    zone.addEventListener('drop', handleDropToZone);
                } else {
                    zone.addEventListener('drop', handleDropToList);
                }
            });

            function handleDragStart(e) {
                console.log('dragstart', this.textContent.trim());
                draggedElement = this;
                // Set drag data so drop zones accept the drop in all browsers
                e.dataTransfer.effectAllowed = 'move';
                // Using text/plain is enough; value not used later but required for Firefox
                e.dataTransfer.setData('text/plain', this.dataset.value || this.textContent.trim());
                this.classList.add('dragging');
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                draggedElement = null;
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDragEnter(e) {
                console.log('dragenter', this.classList.contains('drop-zone') ? 'zone' : 'list');
                if (this.classList.contains('drop-zone')) {
                    this.classList.add('drag-over');
                }
            }

            function handleDragLeave() {
                if (this.classList.contains('drop-zone')) {
                    this.classList.remove('drag-over');
                }
            }

            function handleDropToZone(e) {
                e.preventDefault();
                console.log('drop on zone');
                this.classList.remove('drag-over');
                if (!draggedElement) return;

                // If this zone already contains an item, move that item back to its option list
                if (this.children.length > 0) {
                    const existingItem = this.children[0];
                    const matchingContainer = this.closest('.matching-container');
                    if (matchingContainer) {
                        const list = matchingContainer.querySelector('.matching-options-list');
                        list.appendChild(existingItem);
                    }
                }

                this.appendChild(draggedElement);
                updateAnsweredIndicators();

                // Ensure the dragged option isn't used elsewhere in this matching container
                const matchingContainer = this.closest('.matching-container');
                if (matchingContainer) {
                    const duplicateZones = matchingContainer.querySelectorAll(`.drop-zone .drag-item[data-value="${draggedElement.dataset.value}"]`);
                    duplicateZones.forEach(itemEl => {
                        if (itemEl !== draggedElement) {
                            const parentZone = itemEl.closest('.drop-zone');
                            const list = matchingContainer.querySelector('.matching-options-list');
                            if (parentZone && list) {
                                list.appendChild(itemEl);
                            }
                        }
                    });
                }
            }

            function handleDropToList(e) {
                e.preventDefault();
                console.log('drop back to list');
                if (!draggedElement) return;
                this.appendChild(draggedElement);
                updateAnsweredIndicators();
            }

            // Expose handlers globally for fallback listeners
            window.handleDropToZone = handleDropToZone;
            window.handleDropToList = handleDropToList;

        })();
        /* --------------------------------------------------------------------- */

        // Global delegation (fallback) in case drop listeners on zones fail
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
        document.body.addEventListener('drop', (e) => {
            const dz = e.target.closest('.drop-zone');
            const list = e.target.closest('.matching-options-list');
            if (dz) {
                handleDropToZone.call(dz, e);
            } else if (list) {
                handleDropToList.call(list, e);
            }
        });

        /* === Expand click area for MCQ radio buttons === */
        (function enhanceMCQClickArea(){
            // Add click listener to TDs containing radios in mcq-table
            document.querySelectorAll('.mcq-table td').forEach(td=>{
                const radio = td.querySelector('input[type="radio"]');
                if(!radio) return;
                // Make cursor pointer over entire cell
                td.style.cursor='pointer';
                // Prevent multiple listeners if script re-runs
                if(td.dataset.enhanced) return;
                td.dataset.enhanced = 'true';
                td.addEventListener('click', function(e){
                    if(e.target && e.target.tagName.toLowerCase()==='input') return; // default click on radio
                    radio.checked = true;
                    updateAnsweredIndicators();
                });
            });
        })();

        /* === Ensure unique choices across grouped radios (e.g., Questions 21-23) === */
        (function enforceUniqueChoices(){
            const groups = [ ['q21','q22','q23'] ]; // add other grouped radio question names here if needed

            groups.forEach(groupNames=>{
                const selector = groupNames.map(n=>`input[name="${n}"]`).join(',');
                const radios   = document.querySelectorAll(selector);
                radios.forEach(radio=>{
                    radio.addEventListener('change', ()=>{
                        // Build map of chosen values in this group
                        const chosen = new Map();
                        groupNames.forEach(name=>{
                            const checked = document.querySelector(`input[name="${name}"]:checked`);
                            if(checked) chosen.set(checked.value, name);
                        });
                        // Enable/disable radios so that a value can only appear once in the whole group
                        radios.forEach(r=>{
                            if(!chosen.has(r.value) || chosen.get(r.value)===r.name){
                                r.disabled = false;
                            }else{
                                r.disabled = true;
                            }
                        });
                        updateAnsweredIndicators();
                    });
                });
            });
        })();

        document.addEventListener('DOMContentLoaded', () => {
            updateNavigation();
            setupCheckboxLimits();
        });

        // Global listeners to ensure the results modal can always be closed
        document.addEventListener('click', function(e) {
            if (e.target.id === 'modal-close-button' || e.target.id === 'result-modal') {
                const modal = document.getElementById('result-modal');
                if (modal) modal.style.display = 'none';
            }
        });
        document.addEventListener('keyup', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('result-modal');
                if (modal) modal.style.display = 'none';
            }
        });

        /* === Context menu for highlight === */
        (function enableContextMenu(){
            const menu = document.getElementById('contextMenu');
            const highlightItem = document.getElementById('highlight-item');
            const commentItem   = document.getElementById('comment-item');
            const clearItem     = document.getElementById('clear-item');
            if(!menu) return;
            document.addEventListener('contextmenu', (e)=>{
                // Only activate on text selection inside main container
                const sel = window.getSelection();
                if(sel && !sel.isCollapsed){
                    e.preventDefault();
                    selectedRange = sel.getRangeAt(0);
                    selectedText = sel.toString();
                    const clickedHighlight = e.target.closest('.highlight, .comment-highlight');
                    if(clickedHighlight){
                        e.preventDefault();
                        contextElement = clickedHighlight;
                        highlightItem.style.display='none';
                        commentItem.style.display='none';
                        clearItem.style.display='block';
                        menu.style.top = e.pageY + 'px';
                        menu.style.left = e.pageX + 'px';
                        menu.style.display = 'block';
                    } else if(sel && !sel.isCollapsed){
                        e.preventDefault();
                        selectedRange = sel.getRangeAt(0);
                        selectedText = sel.toString();
                        highlightItem.style.display='block';
                        commentItem.style.display='block';
                        clearItem.style.display='none';
                        menu.style.top = e.pageY + 'px';
                        menu.style.left = e.pageX + 'px';
                        menu.style.display = 'block';
                    } else {
                        // allow default menu when no selection
                        closeContextMenu();
                    }
                } else {
                    // allow default menu when no selection
                    closeContextMenu();
                }
            });
            document.addEventListener('click', (e)=>{
                if(!e.target.closest('#contextMenu')){
                    closeContextMenu();
                }
            });
        })();
    </script>
</body>
</html>
